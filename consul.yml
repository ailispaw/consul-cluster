consul: &consul
  image: progrium/consul
  ports:
    - 8300:8300     # Internal Use
    - 8301:8301/tcp # Internal Use
    - 8301:8301/udp # Internal Use
    - 8302:8302/tcp # Internal Use
    - 8302:8302/udp # Internal Use
    - 8400:8400     # RPC
    - 8500:8500     # HTTP API & UI
    - 53:53/tcp     # DNS
    - 53:53/udp     # DNS
  entrypoint: /bin/sh

bootstrap: &bootstrap
  <<: *consul
  command:
    - -c
    - /bin/start -server -bootstrap -advertise=${NODE_IP} -join=${JOIN_IP}

server: &server
  <<: *consul
  command:
    - -c
    - /bin/start -server -advertise=${NODE_IP} -join=${JOIN_IP}

client: &client
  <<: *consul
  command:
    - -c
    - /bin/start -advertise=${NODE_IP} -join=${JOIN_IP}

node-01:
  <<: *bootstrap

node-02:
  <<: *server

node-03:
  <<: *client

registrator:
  image: gliderlabs/registrator
  volumes:
    - /var/run/docker.sock:/tmp/docker.sock
  links:
    - consul
  command:
    - consul://consul:8500
